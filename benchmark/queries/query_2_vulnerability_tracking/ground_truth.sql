SELECT
    c.[Name] AS CompanyName,
    COUNT(DISTINCT comp.[ID]) AS ComputerCount,
    COUNT(DISTINCT cve.[CVEID]) AS CriticalCVECount
FROM [tb_Company] c
    INNER JOIN [tb_SaasComputers] comp ON c.[ID] = comp.[CompanyID]
    INNER JOIN [tb_SaasComputerCVEMap] cve_map ON comp.[ID] = cve_map.[ComputerID]
    INNER JOIN [tb_CVE] cve ON cve_map.[CVEID] = cve.[CVEID]
    INNER JOIN [tb_SaasPendingPatch] pp ON comp.[ID] = pp.[ComputerID]
WHERE cve.[CVSSScore] > 7.0
    AND comp.[IsDeleted] = 0
    AND cve_map.[IsDeleted] = 0
    AND cve.[IsDeleted] = 0
    AND pp.[IsActive] = 1
GROUP BY c.[ID], c.[Name]
ORDER BY CriticalCVECount DESC, ComputerCount DESC
