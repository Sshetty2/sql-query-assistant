{
  "name": "planner_output",
  "strict": true,
  "schema": {
    "type": "object",
    "additionalProperties": false,
    "properties": {
      "decision": {
        "type": "string",
        "enum": ["proceed", "clarify"],
        "description": "Whether to proceed with query generation or clarify requirements"
      },
      "intent_summary": {
        "type": "string",
        "description": "One sentence summary of what the user wants"
      },
      "selections": {
        "type": "array",
        "description": "Tables and columns needed for this query",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "table": {
              "type": "string",
              "description": "Exact table_name from the schema"
            },
            "alias": {
              "type": ["string", "null"],
              "description": "Optional short alias for readability"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Confidence this table is relevant (0.0–1.0)"
            },
            "reason": {
              "type": ["string", "null"],
              "description": "Why this table was selected"
            },
            "columns": {
              "type": "array",
              "description": "Columns of interest from this table",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "table": {
                    "type": "string",
                    "description": "Table name"
                  },
                  "column": {
                    "type": "string",
                    "description": "Column name"
                  },
                  "role": {
                    "type": "string",
                    "enum": ["projection", "filter", "group_by", "order_by"],
                    "description": "How this column is used"
                  },
                  "reason": {
                    "type": ["string", "null"],
                    "description": "Why this column was chosen"
                  },
                  "value_type": {
                    "type": "string",
                    "enum": ["string", "number", "integer", "boolean", "date", "datetime", "unknown"],
                    "description": "Best-effort type inference"
                  }
                },
                "required": ["table", "column", "role", "value_type"]
              }
            },
            "filters": {
              "type": "array",
              "description": "Filters scoped to this table",
              "items": {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "table": { "type": "string" },
                  "column": { "type": "string" },
                  "op": {
                    "type": "string",
                    "enum": [
                      "=", "!=", ">", ">=", "<", "<=", "between", "in", "not_in",
                      "like", "ilike", "starts_with", "ends_with", "is_null", "is_not_null", "exists"
                    ]
                  },
                  "value": {
                    "description": "Scalar, array for 'in'/'not_in', or [low, high] for 'between' (null allowed for is_null ops)",
                    "oneOf": [
                      { "type": ["string", "number", "boolean", "null"] },
                      {
                        "type": "array",
                        "items": { "type": ["string", "number", "boolean", "null"] }
                      }
                    ]
                  },
                  "source_text": {
                    "type": ["string", "null"],
                    "description": "Snippet from user query that triggered this filter"
                  },
                  "comment": {
                    "type": ["string", "null"],
                    "description": "Why this filter was inferred"
                  }
                },
                "required": ["table", "column", "op"]
              }
            },
            "candidate_keys": {
              "type": ["object", "null"],
              "description": "Key columns for join planning",
              "additionalProperties": false,
              "properties": {
                "primary_keys": {
                  "type": "array",
                  "items": { "type": "string" }
                },
                "foreign_keys": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          },
          "required": ["table", "confidence", "columns"]
        }
      },
      "global_filters": {
        "type": "array",
        "description": "Filters that apply across tables",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "table": { "type": "string" },
            "column": { "type": "string" },
            "op": {
              "type": "string",
              "enum": [
                "=", "!=", ">", ">=", "<", "<=", "between", "in", "not_in",
                "like", "ilike", "starts_with", "ends_with", "is_null", "is_not_null", "exists"
              ]
            },
            "value": {
              "oneOf": [
                { "type": ["string", "number", "boolean", "null"] },
                {
                  "type": "array",
                  "items": { "type": ["string", "number", "boolean", "null"] }
                }
              ]
            },
            "source_text": { "type": ["string", "null"] },
            "comment": { "type": ["string", "null"] }
          },
          "required": ["table", "column", "op"]
        }
      },
      "group_by": {
        "type": "array",
        "description": "Columns for grouping",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "table": { "type": "string" },
            "column": { "type": "string" },
            "role": { "type": "string", "enum": ["group_by"] },
            "reason": { "type": ["string", "null"] },
            "value_type": { "type": "string", "enum": ["string", "number", "integer", "boolean", "date", "datetime", "unknown"] }
          },
          "required": ["table", "column", "role", "value_type"]
        }
      },
      "order_by": {
        "type": "array",
        "description": "Columns for ordering",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "table": { "type": "string" },
            "column": { "type": "string" },
            "role": { "type": "string", "enum": ["order_by"] },
            "reason": { "type": ["string", "null"] },
            "value_type": { "type": "string", "enum": ["string", "number", "integer", "boolean", "date", "datetime", "unknown"] }
          },
          "required": ["table", "column", "role", "value_type"]
        }
      },
      "time_context": {
        "type": ["object", "null"],
        "description": "Resolved time windows",
        "additionalProperties": false,
        "properties": {
          "from_date": { "type": ["string", "null"], "description": "YYYY-MM-DD if inferred" },
          "to_date": { "type": ["string", "null"], "description": "YYYY-MM-DD if inferred" },
          "relative_phrase": { "type": ["string", "null"], "description": "Original NL like 'last 30 days'" }
        }
      },
      "join_hints": {
        "type": "array",
        "description": "Suggested table relationships",
        "items": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "from_table": { "type": "string" },
            "to_table": { "type": "string" },
            "via": { "type": ["string", "null"], "description": "FK column name or relationship label" },
            "reason": { "type": ["string", "null"], "description": "Why this relationship might be relevant" },
            "confidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "Confidence in this join (0.0–1.0)" }
          },
          "required": ["from_table", "to_table"]
        }
      },
      "ambiguities": {
        "type": "array",
        "description": "Questions to resolve or assumptions made",
        "items": { "type": "string" }
      },
      "notes_for_sql_generator": {
        "type": ["string", "null"],
        "description": "Freeform guidance for SQL generation (e.g., expected grain, dedup strategy)"
      },
      "confidence": {
        "type": "number",
        "minimum": 0,
        "maximum": 1,
        "description": "Overall confidence in this plan (0.0–1.0)"
      }
    },
    "required": ["decision", "intent_summary", "selections", "confidence"]
  }
}